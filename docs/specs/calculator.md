# Спецификация калькулятора прибыли ProKaspi

## 1. Входные данные

| Поле | Тип | Описание | Обязательность |
|------|-----|----------|----------------|
| Цена продажи на Kaspi | число (₸) | Цена товара на витрине | обязательно, > 0 |
| Комиссия Kaspi | число (%) | Процент комиссии площадки | обязательно, 0–100 |
| Город доставки | перечисление | Тип доставки | обязательно |
| Диапазон цены | перечисление | Для цен до 10 000 ₸ | при цене ≤ 10 000 |
| Вес товара | перечисление | Для цен свыше 10 000 ₸ | при цене > 10 000 |
| Упаковка | число (₸) | Стоимость упаковки | обязательно, ≥ 0 |
| Себестоимость товара | число (₸) | Затраты на товар | обязательно, ≥ 0 |

### 1.1. Город доставки (тип доставки)

- `kz` — Казахстан (межгород)
- `express` — Express (внутри города)

### 1.2. Диапазон цены (при цене до 10 000 ₸)

- `0_1000` — до 1 000 ₸
- `1000_3000` — 1 000 – 3 000 ₸
- `3000_5000` — 3 000 – 5 000 ₸
- `5000_10000` — 5 000 – 10 000 ₸

### 1.3. Вес товара (при цене свыше 10 000 ₸)

- `0_5` — до 5 кг
- `5_15` — 5 – 15 кг
- `15_30` — 15 – 30 кг
- `30_60` — 30 – 60 кг
- `60_100` — 60 – 100 кг
- `100_plus` — свыше 100 кг

---

## 2. Формулы

### 2.1. Комиссия площадки

```
commissionAmount = round(price * (commissionPercent / 100), 2)
```

Комиссия считается от цены продажи. Округление до 2 знаков после запятой.

### 2.2. Доставка

Стоимость доставки для продавца списывается **с учётом НДС** (Kaspi Гид). Тарифы в справочниках указаны **без НДС**; НДС начисляется отдельно.

1. **Тариф доставки (без НДС)**  
   - **Цена ≤ 10 000 ₸** — по полю «Диапазон цены» и типу доставки (Казахстан / Express) из таблицы ниже.  
   - **Цена > 10 000 ₸** — по полю «Вес товара» и типу доставки из таблицы ниже.  
   - Если диапазон/вес не выбран — тариф = 0.

2. **НДС на доставку (16%)**

```
deliveryVat = round(deliveryTariff * 0.16, 2)
```

3. **Итого списание за доставку**

```
deliveryAmount = deliveryTariff + deliveryVat
```

#### Тарифы доставки с 01.01.2026 (без НДС), источник: [Kaspi Гид — Сколько стоит Kaspi Доставка](https://guide.kaspi.kz/partner/ru/shop/delivery/shipping/q2288), [Express для продавца](https://guide.kaspi.kz/partner/ru/shop/delivery/express/q2953).

**Сумма заказа до 10 000 ₸ (₸ без НДС):**

| Диапазон цены   | Казахстан (kz) | Express |
|-----------------|----------------|--------|
| до 1 000 ₸      | 49,14          | 49,14  |
| 1 000 – 3 000 ₸ | 149,14         | 149,14 |
| 3 000 – 5 000 ₸ | 199,14         | 199,14 |
| 5 000 – 10 000 ₸| 699,14         | 799,14 |

**Сумма заказа 10 000 ₸ и более (₸ без НДС):**

| Вес товара   | Казахстан (kz) | Express   |
|--------------|----------------|-----------|
| до 5 кг      | 1 099,14       | 1 299,14  |
| 5 – 15 кг    | 1 349,14       | 1 699,14  |
| 15 – 30 кг   | 2 299,14       | 3 599,14  |
| 30 – 60 кг   | 2 899,14       | 5 649,14  |
| 60 – 100 кг  | 4 149,14       | 8 549,14  |
| свыше 100 кг | 6 449,14       | 11 999,14 |

### 2.3. Прибыль

```
deliveryAmount = deliveryTariff + deliveryVat
profit = round(price - commissionAmount - deliveryAmount - packaging - costPrice, 2)
```

Все величины в тенге. Округление прибыли до 2 знаков после запятой.

- `price` — цена продажи  
- `commissionAmount` — комиссия площадки  
- `deliveryAmount` — доставка всего (тариф + НДС)  
- `packaging` — упаковка  
- `costPrice` — себестоимость  

### 2.4. Маржа

```
marginPercent = round((profit / price) * 100, 1)
```

Маржа в процентах от цены продажи. Округление до 1 знака. Может быть отрицательной (убыток).

---

## 3. Валидация и границы

### 3.1. Числовые поля

- **Цена продажи**: число, строго больше 0. Максимум не ограничен (или ограничить разумным, например 99 999 999).
- **Комиссия Kaspi**: число от 0 до 100 (включительно). Допускаются дробные (например, 12.5).
- **Упаковка**: число ≥ 0.
- **Себестоимость**: число ≥ 0.

### 3.2. Условные поля

- Если **цена ≤ 10 000**: должен быть выбран «Диапазон цены». Иначе расчёт доставки невозможен — тариф = 0 (или ошибка валидации).
- Если **цена > 10 000**: должен быть выбран «Вес товара». Иначе — аналогично.

### 3.3. Поведение при невалидном вводе

- Пустые обязательные поля → не считать, показать ошибки.
- Отрицательная цена / комиссия &lt; 0 или &gt; 100 → ошибка валидации.
- Нечисловой ввод в числовых полях → ошибка или приведение к 0 (реализация: явная ошибка предпочтительнее).

---

## 4. Граничные случаи

| Случай | Ожидаемое поведение |
|--------|----------------------|
| Цена = 0 | Ошибка валидации, расчёт не выполняется |
| Цена &lt; 0 | Ошибка валидации |
| Комиссия = 0 | Допустимо, commissionAmount = 0 |
| Комиссия = 100 | Допустимо, commissionAmount = price |
| Упаковка = 0, себестоимость = 0 | Допустимо |
| Цена = 10 000 | Диапазон «до 10 000» (5000_10000) |
| Цена = 10 000.01 | «Свыше 10 000», нужен выбор веса |
| Не выбран диапазон при цене ≤ 10 000 | deliveryTariff = 0, deliveryVat = 0 (или ошибка валидации) |
| Не выбран вес при цене > 10 000 | deliveryTariff = 0, deliveryVat = 0 (или ошибка валидации) |
| Прибыль &lt; 0 | Допустимо, показываем убыток и отрицательную маржу |
| price = 0 при расчёте маржи | Не делить на 0; marginPercent не вычислять или считать 0 |

---

## 5. Выходные данные (результат расчёта)

- **commissionAmount** (₸) — комиссия площадки  
- **deliveryTariff** (₸) — тариф доставки без НДС  
- **deliveryVat** (₸) — НДС 16% от тарифа доставки  
- **deliveryAmount** (₸) — доставка всего (тариф + НДС)  
- **packaging** (₸) — упаковка (эхо ввода)  
- **costPrice** (₸) — себестоимость (эхо ввода)  
- **profit** (₸) — прибыль (может быть отрицательной)  
- **totalDeductions** (₸) — списания: commissionAmount + deliveryAmount + packaging  
- **marginPercent** (%) — маржа от цены продажи, один знак после запятой  

---

## 6. Источник тарифов

- [online.prokaspi.kz/calculator](https://online.prokaspi.kz/calculator) — калькулятор ProKaspi.  
- [Kaspi Гид — Сколько стоит Kaspi Доставка](https://guide.kaspi.kz/partner/ru/shop/delivery/shipping/q2288) — тарифы по Казахстану и Express (до 10 000 ₸ и по весу).  
- [Kaspi Гид — Express для продавца](https://guide.kaspi.kz/partner/ru/shop/delivery/express/q2953).  

Константы в коде обновлять при изменении тарифов Kaspi.
